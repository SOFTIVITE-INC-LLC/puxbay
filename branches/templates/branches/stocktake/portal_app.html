<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stocktake Portal | {{ branch.name }}</title>
    {% load static %}
    <link href="{% static 'css/tailwind.css' %}" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="{% static 'css/material-symbols-outlined.css' %}" />
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .touch-manipulation { touch-action: manipulation; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-slate-800">
    <div id="app" class="max-w-md mx-auto h-screen overflow-hidden bg-white shadow-2xl relative flex flex-col">
        <!-- Header -->
        <header class="bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-md">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-lg font-bold">Stocktake Portal</h1>
                    <p class="text-xs text-slate-400">{{ branch.name }}</p>
                </div>
                <div class="text-right">
                     <span class="text-xs font-mono bg-slate-800 px-2 py-1 rounded">{{ session.started_at|date:"M d" }}</span>
                </div>
            </div>
        </header>

        <!-- Search / Scan Input (Fixed) -->
        <div class="bg-white border-b border-slate-200 p-4 z-10 shadow-sm">
            <div class="flex gap-2">
                <div class="relative flex-1">
                    <input 
                        ref="searchInput"
                        v-model="query" 
                        @keyup.enter="searchProduct()"
                        type="text" 
                        placeholder="Search product name, SKU or scan barcode..." 
                        class="w-full text-lg p-4 pl-12 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                    >
                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-2xl">search</span>
                    
                    <button 
                        v-if="query" 
                        @click="query = ''; $refs.searchInput.focus()"
                        class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500 p-2"
                    >
                        <span class="material-symbols-outlined">cancel</span>
                    </button>
                </div>
                <button @click="searchProduct()" class="bg-slate-900 text-white px-6 rounded-xl font-bold shadow-lg active:scale-95 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined">search</span>
                    <span class="hidden md:inline">Search</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 p-4 pb-24 overflow-y-auto bg-gray-50">

            <!-- Search Results -->
            <div v-if="loading" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2 text-slate-400 text-sm">Loading...</p>
            </div>

            <div v-if="products.length > 0" class="space-y-4">
                <div v-for="product in products" :key="product.id" class="p-4 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex gap-4">
                        <!-- Product Info -->
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-slate-800 truncate">[[ product.name ]]</h3>
                            <p class="text-xs text-slate-500 font-mono mt-1">[[ product.barcode || product.sku ]]</p>
                        </div>
                    </div>

                    <!-- Quantity Control -->
                    <div class="mt-4 flex items-center justify-between bg-slate-50 p-2 rounded-lg">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-2">Counted</span>
                        <div class="flex items-center gap-4">
                            <button @click="updateCount(product, -1)" class="w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-600 flex items-center justify-center active:bg-slate-100 touch-manipulation">
                                <span class="material-symbols-outlined">remove</span>
                            </button>
                            <input 
                                type="number" 
                                v-model.number="product.current_count" 
                                @change="manualUpdate(product)" 
                                @focus="$event.target.select()"
                                class="text-2xl font-bold w-24 text-center bg-transparent border-b-2 border-slate-200 focus:border-blue-600 outline-none px-0 py-1 transition-colors"
                            >
                            <button @click="updateCount(product, 1)" class="w-10 h-10 rounded-full bg-blue-600 text-white shadow-lg shadow-blue-200 flex items-center justify-center active:bg-blue-700 touch-manipulation">
                                <span class="material-symbols-outlined">add</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else-if="!loading && hasSearched && query" class="text-center py-12">
                <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">search_off</span>
                <p class="text-slate-500">No products found fitting "[[ query ]]".</p>
                <button @click="query=''; searchProduct()" class="mt-4 text-blue-600 font-bold text-sm">Clear Search</button>
            </div>
            
            <div v-else-if="!loading && products.length === 0" class="text-center py-12 opacity-50">
                <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">inventory_2</span>
                <p class="text-sm">No items in stocktake list.</p>
            </div>

        </main>

        <!-- Notification Toast -->
        <div v-if="toast.show" :class="{'bg-green-500': toast.type==='success', 'bg-red-500': toast.type==='error'}" class="fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-lg text-white font-medium text-sm z-50 transition-all transform duration-300">
            [[ toast.message ]]
        </div>

    </div>

    <script>
        const { createApp } = Vue;
        const SESSION_TOKEN = "{{ token }}";

        createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    query: '',
                    products: [],
                    loading: false,
                    hasSearched: false,
                    toast: { show: false, message: '', type: 'success' },
                    searchDebounce: null
                }
            },
            watch: {
                query( newVal ) {
                    if(newVal.length === 0) {
                         this.searchProduct(); // Auto-reload all
                    } else if(newVal.length > 2) {
                        clearTimeout(this.searchDebounce);
                        this.searchDebounce = setTimeout(() => this.searchProduct(true), 500);
                    }
                }
            },
            methods: {
                async searchProduct(isAuto = false) {
                    this.loading = true;
                    try {
                        const res = await fetch(`/branches/stocktake/portal/${SESSION_TOKEN}/api/scan/?q=${encodeURIComponent(this.query)}`);
                        if (!res.ok) throw new Error('Search failed');
                        const data = await res.json();
                        this.products = data.results;
                        this.hasSearched = true;
                    } catch (e) {
                        this.showToast('Search failed', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                async updateCount(product, change) {
                    const newCount = (product.current_count || 0) + change;
                    if (newCount < 0) return;
                    product.current_count = newCount;
                    await this.syncCount(product, newCount);
                },
                async manualUpdate(product) {
                    const val = parseInt(product.current_count);
                    if (isNaN(val) || val < 0) {
                        product.current_count = 0;
                    }
                    await this.syncCount(product, product.current_count);
                },
                async syncCount(product, quantity) {
                    try {
                        const res = await fetch(`/branches/stocktake/portal/${SESSION_TOKEN}/api/update/`, {
                            method: 'POST',
                            body: JSON.stringify({
                                product_id: product.id,
                                quantity: quantity,
                                mode: 'set'
                            })
                        });
                        if (!res.ok) throw new Error();
                        // this.playSound('success'); // Optional, maybe annoying for manual typing
                    } catch (e) {
                         this.showToast('Update failed!', 'error');
                    }
                },
                showToast(msg, type='success') {
                    this.toast = { show: true, message: msg, type };
                    setTimeout(() => this.toast.show = false, 2000);
                },
                playSound(type) {
                    // Simple beep logic placeholders
                }
            },
            mounted() {
                // Focus but also load initial data
                this.searchProduct(true);
                // this.$refs.searchInput.focus(); // On mobile this might focus-jump, better to let user tap if they want to scan.
            }
        }).mount('#app');
    </script>
</body>
</html>
