{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Strategic Intelligence - {{ branch.name }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.75);
        --glass-border: rgba(255, 255, 255, 0.4);
        --glass-shadow: rgba(31, 38, 135, 0.07);
    }

    html.dark :root {
        --glass-bg: rgba(30, 41, 59, 0.7);
        --glass-border: rgba(255, 255, 255, 0.05);
        --glass-shadow: rgba(0, 0, 0, 0.3);
    }

    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px 0 var(--glass-shadow);
        border-radius: 2rem;
    }

    .kpi-gradient-1 { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    .kpi-gradient-2 { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); }
    .kpi-gradient-3 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .kpi-gradient-4 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

    .chart-box {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .pulse-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
        animation: pulse-ring 2s infinite;
    }

    @keyframes pulse-ring {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .stat-font {
        font-family: 'Outfit', sans-serif;
    }
</style>
{% endblock %}

{% block page_title %}Strategic Intelligence{% endblock %}

{% block content %}
<div class="space-y-8 pb-12 overflow-x-hidden">
    <!-- Header & Controls -->
    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 bg-slate-100 dark:bg-slate-800/50 p-6 rounded-3xl border border-slate-200 dark:border-slate-700">
        <div>
            <h1 class="text-2xl font-black text-slate-900 dark:text-white flex items-center gap-3">
                <span class="p-2 bg-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-200 dark:shadow-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                </span>
                Performance Command
            </h1>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 font-medium">Real-time branch diagnostics and growth metrics.</p>
        </div>

        <div class="flex flex-wrap items-center gap-3">
            <form method="get" class="flex items-center gap-2 bg-white dark:bg-slate-900 p-1.5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="flex items-center px-3 border-r border-slate-100 dark:border-slate-800">
                    <span class="material-symbols-outlined text-slate-400 text-sm mr-2">calendar_today</span>
                    <input type="date" name="date_start" value="{{ date_start }}" 
                        class="border-none bg-transparent text-xs font-bold text-slate-700 dark:text-slate-200 focus:ring-0 p-0 w-28">
                </div>
                <div class="flex items-center px-3">
                    <input type="date" name="date_end" value="{{ date_end }}"
                        class="border-none bg-transparent text-xs font-bold text-slate-700 dark:text-slate-200 focus:ring-0 p-0 w-28">
                </div>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-900 transition-colors">
                    Filter
                </button>
            </form>

            <a href="{% url 'export_sales_csv' branch.id %}" class="inline-flex items-center px-5 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm text-xs font-bold text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <svg class="mr-2 h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Export
            </a>
        </div>
    </div>

    <!-- KPI Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Revenue Card -->
        <div class="glass-card p-8 group hover:translate-y-[-4px] transition-all duration-300">
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 kpi-gradient-1 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-200 dark:shadow-none">
                    <span class="material-symbols-outlined">payments</span>
                </div>
                <span class="text-[10px] font-black text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded-lg uppercase tracking-wider">Gross Revenue</span>
            </div>
            <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 mb-1 uppercase tracking-widest leading-none">Total Sales</h3>
            <div class="flex items-baseline gap-1">
                <span class="text-base font-bold text-slate-400 dark:text-slate-500">{{ branch.currency_symbol }}</span>
                <span class="stat-font text-3xl font-black text-slate-900 dark:text-white">{{ total_sales|floatformat:2 }}</span>
            </div>
        </div>

        <!-- Cost Card -->
        <div class="glass-card p-8 group hover:translate-y-[-4px] transition-all duration-300">
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 kpi-gradient-2 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-sky-200 dark:shadow-none">
                    <span class="material-symbols-outlined">fact_check</span>
                </div>
                <span class="text-[10px] font-black text-sky-600 dark:text-sky-400 bg-sky-50 dark:bg-sky-900/30 px-2 py-1 rounded-lg uppercase tracking-wider">Operating Cost</span>
            </div>
            <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 mb-1 uppercase tracking-widest leading-none">Inventory Value</h3>
            <div class="flex items-baseline gap-1">
                <span class="text-base font-bold text-slate-400 dark:text-slate-500">{{ branch.currency_symbol }}</span>
                <span class="stat-font text-3xl font-black text-slate-900 dark:text-white">{{ total_cost|floatformat:2 }}</span>
            </div>
        </div>

        <!-- Profit Card -->
        <div class="glass-card p-8 group hover:translate-y-[-4px] transition-all duration-300 border-l-4 border-l-emerald-500">
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 kpi-gradient-3 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-200 dark:shadow-none">
                    <span class="material-symbols-outlined">trending_up</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="pulse-dot"></div>
                    <span class="text-[10px] font-black text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-lg uppercase tracking-wider">Net Profit</span>
                </div>
            </div>
            <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 mb-1 uppercase tracking-widest leading-none">Gross Margin</h3>
            <div class="flex items-baseline gap-1">
                <span class="text-base font-bold text-slate-400 dark:text-slate-500">{{ branch.currency_symbol }}</span>
                <span class="stat-font text-3xl font-black {% if gross_profit >= 0 %}text-emerald-600 dark:text-emerald-400{% else %}text-rose-600{% endif %}">
                    {{ gross_profit|floatformat:2 }}
                </span>
            </div>
        </div>

        <!-- Margin Card -->
        <div class="glass-card p-8 group hover:translate-y-[-4px] transition-all duration-300">
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 kpi-gradient-4 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-violet-200 dark:shadow-none">
                    <span class="material-symbols-outlined">pie_chart</span>
                </div>
                <span class="text-[10px] font-black text-violet-600 dark:text-violet-400 bg-violet-50 dark:bg-violet-900/30 px-2 py-1 rounded-lg uppercase tracking-wider">Strategy</span>
            </div>
            <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 mb-1 uppercase tracking-widest leading-none">Profit %</h3>
            <div class="flex items-baseline gap-1">
                <span class="stat-font text-3xl font-black text-slate-900 dark:text-white">{{ margin|floatformat:1 }}</span>
                <span class="text-lg font-bold text-violet-500">%</span>
            </div>
        </div>
    </div>

    <!-- Charts Layer -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Sales velocity takes up 2 columns -->
        <div class="lg:col-span-2 glass-card p-10">
            <div class="mb-10">
                <h2 class="text-xl font-black text-slate-900 dark:text-white flex items-center gap-2">
                    Sales Velocity
                    <span class="text-[10px] font-black text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded uppercase">Historic</span>
                </h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">Daily revenue flow visualization.</p>
            </div>
            
            <div class="chart-box">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Categories takes up 1 column -->
        <div class="lg:col-span-1 glass-card p-10 flex flex-col">
            <div class="mb-10">
                <h2 class="text-xl font-black text-slate-900 dark:text-white">Distribution</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">Categorical market share.</p>
            </div>
            
            <div class="flex-1 flex flex-col justify-center">
                <div class="relative h-60 mb-8">
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="space-y-3" id="legend-ul"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart === 'undefined') return;
        
        const isDark = document.documentElement.classList.contains('dark');
        const textColor = isDark ? '#94a3b8' : '#64748b';
        const gridColor = isDark ? '#1e293b' : '#f1f5f9';

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = textColor;

        // Sales Chart
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        const grad = salesCtx.createLinearGradient(0, 0, 0, 400);
        grad.addColorStop(0, 'rgba(79, 70, 229, 0.15)');
        grad.addColorStop(1, 'rgba(79, 70, 229, 0)');

        new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: {{ chart_dates|safe }},
                datasets: [{
                    label: 'Revenue',
                    data: {{ chart_sales|safe }},
                    borderColor: '#4f46e5',
                    borderWidth: 3,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#4f46e5',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    backgroundColor: grad
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDark ? '#0f172a' : '#1e293b',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 12,
                        cornerRadius: 12,
                        displayColors: false
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 10, weight: '600' } } },
                    y: { 
                        grid: { color: gridColor }, 
                        beginAtZero: true, 
                        ticks: { 
                             font: { size: 10, weight: '600' },
                             callback: v => '{{ branch.currency_symbol }}' + v.toLocaleString()
                        } 
                    }
                }
            }
        });

        // Category Chart
        const catCtx = document.getElementById('categoryChart').getContext('2d');
        const colors = ['#6366f1', '#0ea5e9', '#10b981', '#f59e0b', '#8b5cf6'];

        new Chart(catCtx, {
            type: 'doughnut',
            data: {
                labels: {{ cat_names|safe }},
                datasets: [{
                    data: {{ cat_values|safe }},
                    backgroundColor: colors,
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '80%',
                plugins: { legend: { display: false } }
            }
        });

        // Legend Gen
        const names = {{ cat_names|safe }};
        const vals = {{ cat_values|safe }};
        const total = vals.reduce((a, b) => a + b, 0);
        const ul = document.getElementById('legend-ul');

        names.forEach((n, i) => {
            const perc = total > 0 ? ((vals[i] / total) * 100).toFixed(1) : 0;
            const li = document.createElement('div');
            li.className = 'flex items-center justify-between text-[11px]';
            li.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full" style="background: ${colors[i % colors.length]}"></div>
                    <span class="font-bold text-slate-600 dark:text-slate-300 truncate w-24">${n}</span>
                </div>
                <div class="flex gap-2">
                    <span class="font-black text-slate-300 dark:text-slate-600">${perc}%</span>
                    <span class="font-black text-slate-900 dark:text-white">${vals[i].toLocaleString()}</span>
                </div>
            `;
            ul.appendChild(li);
        });
    });
</script>
{% endblock %}
