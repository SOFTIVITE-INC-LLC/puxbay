{% extends 'dashboard_base.html' %}
{% load static %}
{% load cache %}

{% block title %}Dashboard - {{ branch.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Premium Animations */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-float { animation: float 6s ease-in-out infinite; }
    .animate-float-delayed { animation: float 6s ease-in-out 3s infinite; }
    
    .stagger-1 { animation: fadeUp 0.6s ease-out forwards; opacity: 0; animation-delay: 0.1s; }
    .stagger-2 { animation: fadeUp 0.6s ease-out forwards; opacity: 0; animation-delay: 0.2s; }
    .stagger-3 { animation: fadeUp 0.6s ease-out forwards; opacity: 0; animation-delay: 0.3s; }
    .stagger-4 { animation: fadeUp 0.6s ease-out forwards; opacity: 0; animation-delay: 0.4s; }

    /* Glass Utilities */
    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.5);
    }
    .dark .glass-panel {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border-top: 1px solid rgba(255, 255, 255, 0.8);
        border-left: 1px solid rgba(255, 255, 255, 0.4);
        border-right: 1px solid rgba(255, 255, 255, 0.4);
        border-bottom: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .dark .glass-card {
        background: rgba(30, 41, 59, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }

    /* Gradient Text */
    .text-gradient {
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
</style>
{% endblock %}

{% block page_title %}{{ branch.name }} Dashboard{% endblock %}

{% block content %}
<!-- Premium Hero Section -->
<div class="relative overflow-hidden rounded-[2.5rem] bg-slate-900 shadow-2xl mb-12 group stagger-1">
    <!-- Dynamic Background -->
    <div class="absolute inset-0">
        <div class="absolute inset-0 bg-gradient-to-br from-indigo-900 via-slate-900 to-black z-0"></div>
        <div class="absolute top-0 right-0 w-[800px] h-[800px] bg-indigo-600/20 rounded-full blur-[120px] mix-blend-screen animate-float -translate-y-1/2 translate-x-1/2"></div>
        <div class="absolute bottom-0 left-0 w-[600px] h-[600px] bg-blue-600/20 rounded-full blur-[100px] mix-blend-screen animate-float-delayed translate-y-1/2 -translate-x-1/4"></div>
        
        <!-- Grid Pattern -->
        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSA0MCAwIEwgMCAwIDAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMC41IiBvcGFjaXR5PSIwLjAzIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyaWQpIi8+PC9zdmc+')] opacity-20"></div>
    </div>
    
    <div class="relative z-10 px-8 py-12 sm:px-12 lg:py-16 flex flex-col lg:flex-row justify-between items-center gap-10">
        <div class="flex-1 text-center lg:text-left">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/5 backdrop-blur-md border border-white/10 mb-8 shadow-lg shadow-indigo-500/10 hover:bg-white/10 transition-colors cursor-default">
                <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                <span class="text-[10px] font-bold text-emerald-200 tracking-widest uppercase">Live System Active</span>
            </div>
            
            <h1 class="text-5xl md:text-6xl lg:text-7xl font-black text-white tracking-tight mb-6 leading-tight">
                {{ branch.name }}
                <span class="block text-3xl md:text-4xl font-bold text-blue-200/50 mt-2">Dashboard</span>
            </h1>
            
            <p class="text-lg text-blue-100/70 font-medium max-w-2xl leading-relaxed mx-auto lg:mx-0">
                Welcome back, <span class="text-white font-bold">{{ request.user.first_name|default:request.user.username|title }}</span>. 
                Your command center is ready.
            </p>
        </div>

        <div class="flex flex-col sm:flex-row gap-5 w-full lg:w-auto">
            <!-- Date Card -->
            <div class="glass-panel rounded-2xl p-5 flex flex-col items-center justify-center min-w-[140px] text-center border-0 bg-white/5 hover:bg-white/10 transition-colors">
                <span class="text-xs font-bold text-blue-200/60 uppercase tracking-wider mb-1">Today</span>
                <span class="text-2xl font-black text-white tracking-tight">{% now "j" %}</span>
                <span class="text-sm font-bold text-blue-200">{% now "M, Y" %}</span>
            </div>
            
            <!-- Quick POS Action -->
            <a href="{% url 'pos_view' branch.id %}" 
               class="group relative overflow-hidden rounded-2xl bg-white text-slate-900 px-10 py-5 flex items-center justify-center gap-4 transition-all duration-300 hover:scale-[1.02] shadow-[0_0_40px_-10px_rgba(255,255,255,0.2)] hover:shadow-[0_0_60px_-15px_rgba(255,255,255,0.4)]">
                <div class="absolute inset-0 bg-gradient-to-r from-indigo-50 via-white to-blue-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <div class="relative flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-lg shadow-indigo-200 group-hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined">point_of_sale</span>
                    </div>
                    <div class="text-left">
                        <span class="block text-xs font-bold text-indigo-600 uppercase tracking-wider">Launch Terminal</span>
                        <span class="block text-xl font-black text-slate-900">New Sale</span>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-10 stagger-2">
    {% if request.user.profile.role != 'sales' %}
    <div class="glass-card rounded-2xl p-6 group">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-2xl">payments</span>
            </div>
            <span class="text-xs font-bold text-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded-lg">+12.5%</span>
        </div>
        <div>
            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Total Revenue</p>
            <p class="text-3xl font-black text-slate-900 dark:text-white mt-1">{{ branch_currency_symbol }}{{ total_revenue|floatformat:2 }}</p>
        </div>
    </div>

    <div class="glass-card rounded-2xl p-6 group">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-2xl">shopping_cart</span>
            </div>
            <span class="text-xs font-bold text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded-lg">Today</span>
        </div>
        <div>
            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Orders Processed</p>
            <p class="text-3xl font-black text-slate-900 dark:text-white mt-1">{{ sales_count }}</p>
        </div>
    </div>

    <!-- Online/Kiosk Stats -->
    <div class="glass-card rounded-2xl p-6 group">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-2xl">devices</span>
            </div>
        </div>
        <div>
            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Digital Sales</p>
            <p class="text-3xl font-black text-slate-900 dark:text-white mt-1">{{ branch_currency_symbol }}{{ online_revenue|floatformat:2 }}</p>
        </div>
    </div>

    <div class="glass-card rounded-2xl p-6 group">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-pink-50 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-2xl">shopping_bag</span>
            </div>
             <span class="text-xs font-bold text-pink-500 bg-pink-50 dark:bg-pink-900/20 px-2 py-1 rounded-lg">Web/App</span>
        </div>
        <div>
            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Online Orders</p>
            <p class="text-3xl font-black text-slate-900 dark:text-white mt-1">{{ online_orders_count }}</p>
        </div>
    </div>

    <!-- Accounts Receivable -->
    <div class="glass-card rounded-2xl p-6 group border-rose-100 dark:border-rose-900/30">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-2xl">account_balance_wallet</span>
            </div>
            <span class="text-xs font-bold text-rose-500 bg-rose-50 dark:bg-rose-900/20 px-2 py-1 rounded-lg">Branch</span>
        </div>
        <div>
            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Accounts Receivable</p>
            <p class="text-3xl font-black text-slate-900 dark:text-white mt-1">{{ branch_currency_symbol }}{{ total_customer_debt|floatformat:2 }}</p>
        </div>
    </div>

    <!-- Accounts Payable -->
    <div class="glass-card rounded-2xl p-6 group border-amber-100 dark:border-amber-900/30">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-2xl">account_balance_wallet</span>
            </div>
            <span class="text-xs font-bold text-amber-500 bg-amber-50 dark:bg-amber-900/20 px-2 py-1 rounded-lg">Branch</span>
        </div>
        <div>
            <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Accounts Payable</p>
            <p class="text-3xl font-black text-slate-900 dark:text-white mt-1">{{ branch_currency_symbol }}{{ total_supplier_debt|floatformat:2 }}</p>
        </div>
    </div>
    {% endif %}

    {% if request.user.profile.role == 'sales' %}
    <!-- Sales Rep Stats -->
    <div class="rounded-3xl bg-gradient-to-br from-indigo-500 to-purple-600 p-8 text-white relative overflow-hidden shadow-2xl shadow-indigo-500/20 col-span-2 group hover:scale-[1.02] transition-transform duration-300">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 group-hover:bg-white/20 transition-colors"></div>
        <div class="relative z-10 flex flex-col h-full justify-between">
            <div class="flex items-start justify-between">
                <div>
                     <p class="text-indigo-100 font-bold uppercase tracking-widest text-xs mb-1">Personal Performance</p>
                    <h3 class="text-2xl font-black">My Sales Dashboard</h3>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                    <span class="material-symbols-outlined text-2xl">trending_up</span>
                </div>
            </div>
            
            <div class="mt-8">
                 <p class="text-5xl font-black mb-2">{{ branch_currency_symbol }}{{ my_total_sales|floatformat:2 }}</p>
                 <div class="flex items-center gap-2 text-indigo-100 font-medium">
                     <span class="material-symbols-outlined text-sm">check_circle</span>
                     <span>{{ my_total_orders }} completed transactions today</span>
                 </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Common Stats -->
    {% if request.user.profile.role != 'sales' %}
    <!-- Staff Card -->
    <div class="glass-card rounded-2xl p-6 group hover:border-orange-200 dark:hover:border-orange-900/50 transition-colors">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-2xl">group</span>
            </div>
            <div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Active Staff</p>
                <p class="text-3xl font-black text-slate-900 dark:text-white">{{ staff_count }}</p>
            </div>
        </div>
    </div>

    <!-- Stock Card -->
    <div class="glass-card rounded-2xl p-6 group hover:border-emerald-200 dark:hover:border-emerald-900/50 transition-colors">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-2xl">inventory_2</span>
            </div>
            <div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Products</p>
                <p class="text-3xl font-black text-slate-900 dark:text-white">{{ stock_count }}</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Smart Stock Alerts (AI Powered) -->
{% if recommendations %}
{% cache 300 branch_recommendations branch.id %}
<div class="glass-panel mb-10 rounded-[2rem] overflow-hidden group stagger-3 hover:shadow-2xl hover:shadow-indigo-500/10 transition-shadow duration-500">
    <div class="px-8 py-6 border-b border-indigo-100/50 flex items-center justify-between bg-gradient-to-r from-indigo-50/50 to-purple-50/50">
        <div class="flex items-center gap-4">
            <div class="relative">
                <div class="absolute inset-0 bg-indigo-500 rounded-full blur animate-pulse opacity-50"></div>
                <div class="relative h-12 w-12 rounded-full bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center text-white shadow-xl shadow-indigo-500/30">
                    <span class="material-symbols-outlined">auto_awesome</span>
                </div>
            </div>
            <div>
                <h3 class="text-lg font-black text-slate-800 tracking-tight">AI Stock Insights</h3>
                <p class="text-sm text-indigo-600 font-bold">Predictive reorder recommendations</p>
            </div>
        </div>
        <span class="bg-white/80 backdrop-blur-sm text-indigo-600 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest shadow-sm border border-indigo-100">Live Analysis</span>
    </div>
    <div class="p-0">
        <div class="grid grid-cols-1 divide-y divide-indigo-50/50">
            {% for rec in recommendations %}
            <div class="p-6 hover:bg-indigo-50/30 transition-colors flex flex-col md:flex-row md:items-center justify-between gap-6 group/item">
                <div class="flex items-center gap-5">
                    {% if rec.product.image %}
                        <img src="{{ rec.product.image.url }}" class="h-16 w-16 rounded-2xl object-cover shadow-md group-hover/item:scale-105 transition-transform duration-300" alt="{{ rec.product.name }}">
                    {% else %}
                        <div class="h-16 w-16 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-400 shadow-inner">
                            <span class="material-symbols-outlined">image</span>
                        </div>
                    {% endif %}
                    <div>
                        <h4 class="font-bold text-lg text-slate-900 mb-1">{{ rec.product.name }}</h4>
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md">Stock: {{ rec.current_stock }}</span>
                            <span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-md">Vel: {{ rec.predicted_velocity|floatformat:1 }}/day</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4 sm:gap-10">
                    <div class="text-center">
                        <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1">Stockout In</p>
                        <div class="text-lg font-black {% if rec.estimated_days_left <= 2 %}text-red-500{% else %}text-indigo-500{% endif %}">
                            {{ rec.estimated_days_left }} <span class="text-xs text-slate-400 font-bold">days</span>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-50 rounded-2xl p-1 flex items-center gap-1">
                        <div class="hidden sm:block px-4 text-right">
                             <span class="block text-[10px] font-bold text-indigo-400 uppercase tracking-wider">Reorder</span>
                             <span class="block text-sm font-black text-indigo-900">+{{ rec.recommended_reorder_quantity }}</span>
                        </div>
                        <a href="{% url 'purchase_order_create' branch.id %}?product_id={{ rec.product.id }}&qty={{ rec.recommended_reorder_quantity }}" class="flex items-center justify-center w-10 h-10 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg shadow-indigo-200 transition-all hover:scale-110 active:scale-95">
                            <span class="material-symbols-outlined text-lg">add_shopping_cart</span>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endcache %}
{% endif %}

{% if missing_barcodes_count > 0 %}
<div class="mb-8 overflow-hidden rounded-2xl bg-white border border-amber-100 shadow-xl shadow-amber-500/5">
    <div class="bg-gradient-to-r from-amber-50 to-orange-50 px-6 py-4 border-b border-amber-100 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-full bg-amber-600 flex items-center justify-center text-white shadow-lg shadow-amber-200">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM6 6h4v4H6V6zm12 0h-4v4h4V6zM6 18h4v-4H6v4zm6-7a2 2 0 110-4 2 2 0 010 4zm3 3a2 2 0 110-4 2 2 0 010 4z" />
                </svg>
            </div>
            <div>
                <h3 class="text-sm font-bold text-slate-800">Barcode Hub</h3>
                <p class="text-xs text-amber-700 font-medium">{{ missing_barcodes_count }} products are currently missing barcodes</p>
            </div>
        </div>
        <a href="{% url 'bulk_generate_barcodes' branch.id %}" class="inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-bold rounded-lg text-white bg-amber-600 hover:bg-amber-700 transition-all duration-200">
            Generate All Barcodes
        </a>
    </div>
</div>
{% endif %}

    {% if request.user.profile.role != 'sales' %}
    {% cache 600 branch_analytics branch.id %}
    <!-- Analytics Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10 stagger-4">
        <!-- Revenue Trend Chart -->
        <div class="glass-panel rounded-3xl p-6 lg:col-span-2 relative group">
            <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-transparent via-indigo-500 to-transparent opacity-20"></div>
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 shadow-inner">
                        <span class="material-symbols-outlined">show_chart</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-black text-slate-800 dark:text-white">Revenue Analysis</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">7 Day Trend</p>
                    </div>
                </div>
            </div>
            <div class="relative h-72 w-full">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Top Products Chart -->
        <div class="glass-panel rounded-3xl p-6 lg:col-span-1 flex flex-col relative group">
             <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent opacity-20"></div>
            <div class="flex items-center gap-4 mb-8">
                <div class="w-12 h-12 rounded-2xl bg-amber-50 dark:bg-amber-900/30 flex items-center justify-center text-amber-600 dark:text-amber-400 shadow-inner">
                    <span class="material-symbols-outlined">star</span>
                </div>
                <div>
                    <h3 class="text-lg font-black text-slate-800 dark:text-white">Top Performers</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Revenue Share</p>
                </div>
            </div>
            <div class="relative flex-1 min-h-[250px] flex items-center justify-center">
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
        
        <!-- Peak Hours Chart -->
        <div class="glass-panel rounded-3xl p-6 lg:col-span-3 relative group">
             <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-transparent via-purple-500 to-transparent opacity-20"></div>
            <div class="flex items-center gap-4 mb-8">
                <div class="w-12 h-12 rounded-2xl bg-purple-50 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 shadow-inner">
                    <span class="material-symbols-outlined">schedule</span>
                </div>
                <div>
                    <h3 class="text-lg font-black text-slate-800 dark:text-white">Peak Activity</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Traffic by Hour</p>
                </div>
            </div>
            <div class="relative h-64 w-full">
                <canvas id="peakHoursChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Chart.js Integration -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Common Options
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#64748b';
            
            // 1. Revenue Chart
            const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
            
            // Create Gradient
            const gradientRevenue = ctxRevenue.createLinearGradient(0, 0, 0, 400);
            gradientRevenue.addColorStop(0, 'rgba(79, 70, 229, 0.4)'); // Purple-ish
            gradientRevenue.addColorStop(1, 'rgba(79, 70, 229, 0.0)');

            new Chart(ctxRevenue, {
                type: 'line',
                data: {
                    labels: JSON.parse('{{ sales_trend_labels|safe }}'),
                    datasets: [{
                        label: 'Revenue',
                        data: JSON.parse('{{ sales_trend_data|safe }}'),
                        borderColor: '#4f46e5', // Indigo-600
                        backgroundColor: gradientRevenue,
                        borderWidth: 2,
                        tension: 0.4, // Curvy lines
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#4f46e5',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            padding: 12,
                            titleFont: { size: 13 },
                            bodyFont: { size: 14, weight: 'bold' },
                            callbacks: {
                                label: function(context) {
                                    return 'Revenue: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [2, 4], color: '#f1f5f9' },
                            ticks: { callback: function(value) { return '$' + value; } }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // 2. Top Products Chart (Doughnut)
            const ctxProducts = document.getElementById('topProductsChart').getContext('2d');
            new Chart(ctxProducts, {
                type: 'doughnut',
                data: {
                    labels: JSON.parse('{{ top_products_labels|safe }}'),
                    datasets: [{
                        data: JSON.parse('{{ top_products_data|safe }}'),
                        backgroundColor: [
                            '#4f46e5', // Indigo
                            '#06b6d4', // Cyan
                            '#f59e0b', // Amber
                            '#10b981', // Emerald
                            '#ef4444'  // Red
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { usePointStyle: true, boxWidth: 8 }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            callbacks: {
                                label: function(context) {
                                    let value = context.parsed;
                                    let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    let percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return context.label + ': $' + value.toFixed(2) + ' (' + percentage + ')';
                                }
                            }
                        }
                    }
                }
            });

            // 3. Peak Hours Chart (Bar)
            const ctxHours = document.getElementById('peakHoursChart').getContext('2d');
            new Chart(ctxHours, {
                type: 'bar',
                data: {
                    labels: JSON.parse('{{ peak_hours_labels|safe }}'),
                    datasets: [{
                        label: 'Orders',
                        data: JSON.parse('{{ peak_hours_data|safe }}'),
                        backgroundColor: '#8b5cf6', // Violet
                        borderRadius: 4,
                        hoverBackgroundColor: '#7c3aed'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            callbacks: {
                                title: function(context) {
                                    return context[0].label + ':00 - ' + context[0].label + ':59';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [2, 4], color: '#f1f5f9' },
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        });
    </script>
    {% endcache %}
    {% endif %}

{% if request.user.profile.role == 'sales' %}
<div class="mb-12">
    <div class="px-2 py-5 flex items-center justify-between">
        <h3 class="text-xl font-black text-slate-800 dark:text-white pl-2 border-l-4 border-indigo-500">Live Activity Feed</h3>
        <a href="{% url 'transaction_list' branch.id %}" class="inline-flex items-center text-sm font-bold text-indigo-600 hover:text-indigo-700 bg-indigo-50 px-4 py-2 rounded-full hover:bg-indigo-100 transition-colors">
            View History
            <span class="material-symbols-outlined ml-1 text-base">arrow_forward</span>
        </a>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full border-separate border-spacing-y-3">
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">Reference</th>
                    <th class="px-6 py-3 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">Time</th>
                    <th class="px-6 py-3 text-left text-[10px] font-black text-slate-400 uppercase tracking-widest">Status</th>
                    <th class="px-6 py-3 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">Amount</th>
                    <th class="px-6 py-3 text-right text-[10px] font-black text-slate-400 uppercase tracking-widest">Action</th>
                </tr>
            </thead>
            <tbody class="text-sm">
                {% for order in my_recent_orders %}
                <tr class="group transition-all duration-300 hover:transform hover:-translate-y-1 hover:shadow-lg">
                    <td class="bg-white dark:bg-slate-800 px-6 py-5 rounded-l-2xl border-l-[6px] {% if order.status == 'completed' %}border-emerald-500{% else %}border-amber-500{% endif %} font-mono font-bold text-indigo-600 dark:text-indigo-400">
                        #{{ order.id }}
                    </td>
                    <td class="bg-white dark:bg-slate-800 px-6 py-5 font-bold text-slate-600 dark:text-slate-300">
                        {{ order.created_at|date:"M d, H:i" }}
                    </td>
                     <td class="bg-white dark:bg-slate-800 px-6 py-5">
                        {% if order.status == 'completed' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            Completed
                        </span>
                        {% else %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">
                             <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span>
                             {{ order.status|title }}
                        </span>
                        {% endif %}
                    </td>
                    <td class="bg-white dark:bg-slate-800 px-6 py-5 text-right font-black text-slate-900 dark:text-white text-base">
                        {{ branch_currency_symbol }}{{ order.total_amount }}
                    </td>
                     <td class="bg-white dark:bg-slate-800 px-6 py-5 rounded-r-2xl text-right">
                        <a href="{% url 'transaction_detail' branch.id order.id %}" class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:bg-indigo-600 hover:text-white transition-all shadow-sm hover:shadow-indigo-300" title="View Details">
                            <span class="material-symbols-outlined text-xl">arrow_forward</span>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="bg-white/50 dark:bg-slate-800/50 rounded-2xl px-6 py-16 text-center text-slate-500">
                        <div class="flex flex-col items-center justify-center">
                            <div class="w-16 h-16 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mb-4">
                                <span class="material-symbols-outlined text-3xl text-slate-300">receipt_long</span>
                            </div>
                            <p class="text-base font-bold">No recent transactions found.</p>
                            <p class="text-sm font-medium text-slate-400 mt-1">Ready to start selling?</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12 stagger-4">
    <!-- Branch Details Card -->
    <div class="glass-panel rounded-[2rem] overflow-hidden h-full flex flex-col group hover:shadow-xl transition-all duration-300">
        <div class="px-8 py-6 border-b border-indigo-50/30 flex items-center justify-between bg-gradient-to-r from-slate-50/50 to-indigo-50/30">
            <h3 class="text-lg font-black text-slate-800">Branch Profile</h3>
             {% if request.user.profile.role != 'sales' and request.user.profile.role != 'financial'%}
             <a href="{% url 'branch_update' branch.pk %}" class="text-sm font-bold text-indigo-600 hover:text-indigo-700 hover:underline flex items-center gap-1">
                 <span class="material-symbols-outlined text-base">edit</span>
                 Edit details
             </a>
             {% endif %}
        </div>
        <div class="p-8 flex-grow">
            <dl class="grid grid-cols-1 gap-x-8 gap-y-8 sm:grid-cols-2">
                <div>
                    <dt class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Address</dt>
                    <dd class="text-base font-bold text-slate-900 border-l-2 border-indigo-200 pl-3">{{ branch.address }}</dd>
                </div>
                <div>
                    <dt class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Phone</dt>
                    <dd class="text-base font-bold text-slate-900 border-l-2 border-indigo-200 pl-3">{{ branch.phone|default:"-" }}</dd>
                </div>
                <div>
                    <dt class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Manager</dt>
                    <dd class="text-base font-bold text-slate-900 border-l-2 border-indigo-200 pl-3">{{ manager.user.get_full_name|default:manager.user.username|default:"No Manager Assigned" }}</dd>
                </div>
                <div>
                    <dt class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Established</dt>
                    <dd class="text-base font-bold text-slate-900 border-l-2 border-indigo-200 pl-3">{{ branch.created_at|date:"M d, Y" }}</dd>
                </div>
            </dl>
        </div>
    </div>

    {% if request.user.profile.role != 'financial' %}
    <!-- Quick Actions -->
    <div class="glass-panel rounded-[2rem] overflow-hidden h-full flex flex-col group hover:shadow-xl transition-all duration-300">
        <div class="px-8 py-6 border-b border-indigo-50/30 bg-gradient-to-r from-slate-50/50 to-indigo-50/30">
            <h3 class="text-lg font-black text-slate-800">Quick Actions</h3>
        </div>
        <div class="p-8 grid grid-cols-2 gap-5 flex-grow content-start">
            {% if request.user.profile.role != 'sales' %}
            <a href="{% url 'category_list' branch.id %}" class="flex flex-col items-center justify-center p-5 bg-white/40 border border-white/50 rounded-2xl hover:bg-white hover:border-indigo-200 hover:shadow-lg transition-all duration-300 group text-center cursor-pointer backdrop-blur-sm">
                 <div class="h-12 w-12 bg-indigo-50 rounded-xl flex items-center justify-center mb-3 group-hover:bg-indigo-600 group-hover:text-white transition-all text-indigo-500 shadow-sm">
                     <span class="material-symbols-outlined text-2xl">category</span>
                 </div>
                <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-700">Categories</span>
            </a>

            <a href="{% url 'product_list' branch.id %}" class="flex flex-col items-center justify-center p-5 bg-white/40 border border-white/50 rounded-2xl hover:bg-white hover:border-indigo-200 hover:shadow-lg transition-all duration-300 group text-center cursor-pointer backdrop-blur-sm">
                 <div class="h-12 w-12 bg-indigo-50 rounded-xl flex items-center justify-center mb-3 group-hover:bg-indigo-600 group-hover:text-white transition-all text-indigo-500 shadow-sm">
                     <span class="material-symbols-outlined text-2xl">inventory_2</span>
                 </div>
                <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-700">Products</span>
            </a>
            {% endif %}

            <a href="{% url 'pos_view' branch.id %}" class="flex flex-col items-center justify-center p-5 bg-gradient-to-br from-indigo-500 to-blue-600 border border-transparent rounded-2xl shadow-lg hover:shadow-indigo-500/30 hover:scale-[1.02] transition-all duration-300 group text-center cursor-pointer col-span-2 sm:col-span-1">
                 <div class="h-12 w-12 bg-white/20 rounded-xl flex items-center justify-center mb-3 text-white backdrop-blur-md">
                     <span class="material-symbols-outlined text-2xl">point_of_sale</span>
                 </div>
                <span class="text-sm font-black text-white">New Sale</span>
            </a>

            {% if request.user.profile.role != 'sales' %}
            <a href="{% url 'purchase_order_create' branch.id %}" class="flex flex-col items-center justify-center p-5 bg-white/40 border border-white/50 rounded-2xl hover:bg-white hover:border-indigo-200 hover:shadow-lg transition-all duration-300 group text-center cursor-pointer backdrop-blur-sm">
                 <div class="h-12 w-12 bg-indigo-50 rounded-xl flex items-center justify-center mb-3 group-hover:bg-indigo-600 group-hover:text-white transition-all text-indigo-500 shadow-sm">
                     <span class="material-symbols-outlined text-2xl">add_box</span>
                 </div>
                <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-700">Add Stock</span>
            </a>

            <a href="{% url 'print_branch_qr' branch.id %}" target="_blank" class="flex flex-col items-center justify-center p-5 bg-white/40 border border-white/50 rounded-2xl hover:bg-white hover:border-indigo-200 hover:shadow-lg transition-all duration-300 group text-center cursor-pointer backdrop-blur-sm">
                <div class="h-12 w-12 bg-indigo-50 rounded-xl flex items-center justify-center mb-3 group-hover:bg-indigo-600 group-hover:text-white transition-all text-indigo-500 shadow-sm">
                    <span class="material-symbols-outlined text-2xl">qr_code_2</span>
                </div>
               <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-700">Storefront QR</span>
           </a>
            <a href="{% url 'bulk_generate_barcodes' branch.id %}" class="flex flex-col items-center justify-center p-5 bg-white/40 border border-white/50 rounded-2xl hover:bg-white hover:border-indigo-200 hover:shadow-lg transition-all duration-300 group text-center cursor-pointer backdrop-blur-sm">
                <div class="h-12 w-12 bg-indigo-50 rounded-xl flex items-center justify-center mb-3 group-hover:bg-indigo-600 group-hover:text-white transition-all text-indigo-500 shadow-sm">
                    <span class="material-symbols-outlined text-2xl">qr_code_scanner</span>
                </div>
               <span class="text-sm font-bold text-slate-700 group-hover:text-indigo-700">Bulk Barcodes</span>
            </a>

            <!-- Additional quick actions could go here -->
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
