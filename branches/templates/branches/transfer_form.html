{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}New Stock Transfer - {{ branch.name }}{% endblock %}
{% block page_title %}New Stock Transfer{% endblock %}

{% block content %}
<div id="transfer-form-container" class="max-w-5xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="flex mb-6 text-sm font-medium text-slate-500" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li><a href="{% url 'branch_dashboard' branch.id %}" class="hover:text-blue-600 transition-colors">{{ branch.name }}</a></li>
            <li><span class="text-slate-300">/</span></li>
            <li><a href="{% url 'transfer_list' branch.id %}" class="hover:text-blue-600 transition-colors">Transfers</a></li>
            <li><span class="text-slate-300">/</span></li>
            <li class="text-slate-900" aria-current="page">New Transfer</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900 tracking-tight">New Stock Transfer</h1>
        <p class="mt-2 text-slate-500">Transfer inventory from {{ branch.name }} to another branch.</p>
    </div>

    <!-- Form Card -->
    <div class="bg-white rounded-xl shadow-lg shadow-slate-200/50 border border-slate-200 overflow-hidden">
        <form method="post" id="transfer-form">
            {% csrf_token %}
            
            <!-- Transfer Details Section -->
            <div class="px-8 py-6 border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-lg font-semibold text-slate-900">Transfer Details</h3>
                <p class="text-sm text-slate-500">Select the destination branch for this transfer.</p>
            </div>
            
            <div class="p-8 space-y-8">
                <!-- Destination Branch -->
                <div>
                    <label for="id_destination_branch" class="block text-sm font-medium text-slate-700 mb-1">
                        Destination Branch <span class="text-red-500">*</span>
                    </label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                            <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <select name="destination_branch" id="id_destination_branch" required 
                            class="block w-full pl-10 pr-10 h-11 rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm appearance-none">
                            {% for x, y in form.fields.destination_branch.choices %}
                            <option value="{{ x }}" {% if form.destination_branch.value == x %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items to Transfer Section -->
            <div class="px-8 py-6 border-t border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-lg font-semibold text-slate-900">Items to Transfer</h3>
                <p class="text-sm text-slate-500">Select products and quantities to transfer.</p>
            </div>

            <div class="p-8 space-y-6">
                <!-- Add Item Controls -->
                <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div class="md:col-span-8">
                            <label class="block text-xs font-medium text-slate-600 mb-2">Product</label>
                            <select id="product-select"
                                class="block w-full h-10 rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500 text-sm">
                                <option value="">Select a Product...</option>
                                {% for p in products %}
                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-cost="{{ p.cost_price|default:0 }}" data-stock="{{ p.stock_quantity }}">
                                    {{ p.name }} (Stock: {{ p.stock_quantity }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-medium text-slate-600 mb-2">Quantity</label>
                            <input type="number" id="qty-input" min="1" placeholder="Qty" value="1"
                                class="block w-full h-10 rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="md:col-span-2 flex items-end">
                            <button type="button" id="add-item-btn" 
                                class="w-full h-10 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                Add
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bulk Adjustment -->
                <div id="markup-section" class="bg-indigo-50 rounded-lg p-6 border border-indigo-100 flex items-center justify-between hidden">
                    <div>
                        <h4 class="font-semibold text-indigo-900">Bulk Price Adjustment</h4>
                        <p class="text-xs text-indigo-700">Apply a markup percentage to all items based on their cost price.</p>
                    </div>
                    <div class="flex items-end gap-3">
                        <div>
                            <label class="block text-xs font-medium text-indigo-800 mb-1">Markup %</label>
                            <input type="number" id="markup-input" class="block w-24 h-9 rounded-md border-indigo-200 focus:border-indigo-500 focus:ring-indigo-500 text-sm" placeholder="0">
                        </div>
                        <button type="button" id="apply-markup-btn" class="h-9 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md text-sm font-medium transition-colors">
                            Apply
                        </button>
                    </div>
                </div>

                <!-- Items Table -->
                <div id="items-table-container" class="overflow-hidden rounded-lg border border-slate-200 hidden">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Product</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Qty</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Transfer Price</th>
                                <th class="px-6 py-3 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="items-table-body" class="bg-white divide-y divide-slate-100">
                           <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="text-center py-12 bg-slate-50 rounded-lg border-2 border-dashed border-slate-200">
                    <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                    </svg>
                    <p class="mt-2 text-sm text-slate-500">No items added yet. Add products above to create your transfer.</p>
                </div>

                <!-- Notes -->
                <div>
                    <label for="id_notes" class="block text-sm font-medium text-slate-700 mb-1">Notes (Optional)</label>
                    <div class="relative rounded-md shadow-sm">
                        <div class="absolute top-3 left-3 pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                        </div>
                        <textarea id="id_notes" name="notes" rows="3" 
                            class="block w-full pl-10 pt-3 rounded-lg border-slate-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm" 
                            placeholder="Add any notes about this transfer..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Hidden Input for JSON -->
            <input type="hidden" name="items_json" id="items-json">

            <!-- Form Actions -->
            <div class="px-8 py-6 bg-slate-50 border-t border-slate-200 flex items-center justify-end gap-3">
                <a href="{% url 'transfer_list' branch.id %}" 
                    class="px-5 py-2.5 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors">
                    Cancel
                </a>
                <button type="submit" id="submit-btn" disabled 
                    class="inline-flex items-center justify-center px-6 py-2.5 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed shadow-blue-200 transition-all hover:scale-[1.02] disabled:hover:scale-100">
                    <svg class="w-5 h-5 mr-2 -ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                    Create Transfer
                </button>
            </div>
        </form>
    </div>
</div>

<script src="{% static 'js/offline-forms.js' %}"></script>
<script>
    class TransferForm {
        constructor() {
            this.items = [];
            this.productSelect = document.getElementById('product-select');
            this.qtyInput = document.getElementById('qty-input');
            this.addBtn = document.getElementById('add-item-btn');
            this.itemsTableBody = document.getElementById('items-table-body');
            this.itemsTableContainer = document.getElementById('items-table-container');
            this.emptyState = document.getElementById('empty-state');
            this.markupSection = document.getElementById('markup-section');
            this.markupInput = document.getElementById('markup-input');
            this.applyMarkupBtn = document.getElementById('apply-markup-btn');
            this.itemsJson = document.getElementById('items-json');
            this.submitBtn = document.getElementById('submit-btn');
            this.form = document.getElementById('transfer-form');

            this.init();
        }

        init() {
            if (this.addBtn) {
                this.addBtn.addEventListener('click', () => this.addItem());
            }

            if (this.applyMarkupBtn) {
                this.applyMarkupBtn.addEventListener('click', () => this.applyMarkup());
            }

            if (this.form) {
                this.form.addEventListener('submit', (e) => {
                    if (this.items.length === 0) {
                        e.preventDefault();
                        showToast("Please add at least one item to the transfer.", 'warning');
                    }
                });
            }
        }

        addItem() {
            const productId = this.productSelect.value;
            const qty = parseInt(this.qtyInput.value);

            if (!productId || qty < 1) {
                showToast('Please select a product and enter a valid quantity.', 'warning');
                return;
            }

            const option = this.productSelect.options[this.productSelect.selectedIndex];
            const stock = parseInt(option.getAttribute('data-stock'));
            const cost = parseFloat(option.getAttribute('data-cost')) || 0;
            const price = parseFloat(option.getAttribute('data-price')) || 0;
            const defaultPrice = (cost > 0 ? cost : price).toFixed(2);
            const name = option.text.split(' (')[0];

            if (qty > stock) {
                showToast(`Cannot transfer more than available stock (${stock})`, 'error');
                return;
            }

            const existing = this.items.find(i => i.product_id === productId);

            if (existing) {
                if (existing.quantity + qty > stock) {
                    showToast(`Total quantity exceeds stock (${stock})`, 'error');
                    return;
                }
                existing.quantity += qty;
            } else {
                this.items.push({
                    product_id: productId,
                    product_name: name,
                    quantity: qty,
                    cost_price: cost,
                    transfer_price: defaultPrice
                });
            }

            this.productSelect.value = '';
            this.qtyInput.value = '1';
            this.render();
        }

        removeItem(index) {
            this.items.splice(index, 1);
            this.render();
        }

        updateItem(index, field, value) {
            if (this.items[index]) {
                if (field === 'quantity') this.items[index].quantity = parseInt(value);
                if (field === 'transfer_price') this.items[index].transfer_price = parseFloat(value).toFixed(2);
                this.updateJson();
            }
        }

        applyMarkup() {
            const markup = parseFloat(this.markupInput.value) || 0;
            if (this.items.length === 0) return;

            this.items.forEach(item => {
                if (item.cost_price > 0) {
                    const added = item.cost_price * (markup / 100);
                    item.transfer_price = (item.cost_price + added).toFixed(2);
                }
            });
            this.render();
        }

        updateJson() {
            this.itemsJson.value = JSON.stringify(this.items);
        }

        render() {
            if (this.items.length > 0) {
                this.itemsTableContainer.classList.remove('hidden');
                this.markupSection.classList.remove('hidden');
                this.emptyState.classList.add('hidden');
                this.submitBtn.disabled = false;
            } else {
                this.itemsTableContainer.classList.add('hidden');
                this.markupSection.classList.add('hidden');
                this.emptyState.classList.remove('hidden');
                this.submitBtn.disabled = true;
            }

            this.itemsTableBody.innerHTML = this.items.map((item, index) => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${item.product_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                         <input type="number" value="${item.quantity}" min="1" 
                            onchange="transferForm.updateItem(${index}, 'quantity', this.value)"
                            class="w-20 text-right rounded-md border-slate-300 py-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="relative rounded-md shadow-sm max-w-[120px] ml-auto">
                            <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                                <span class="text-slate-500 sm:text-xs">$</span>
                            </div>
                            <input type="number" value="${item.transfer_price}" step="0.01" 
                                onchange="transferForm.updateItem(${index}, 'transfer_price', this.value)"
                                class="block w-full pl-6 text-right rounded-md border-slate-300 py-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button type="button" onclick="transferForm.removeItem(${index})" 
                            class="text-red-600 hover:text-red-800 font-medium transition-colors">
                            Remove
                        </button>
                    </td>
                </tr>
            `).join('');

            this.updateJson();
        }
    }

    let transferForm;
    document.addEventListener('DOMContentLoaded', () => {
        transferForm = new TransferForm();

        // Initialize Offline Manager
        new OfflineFormManager({
            formId: 'transfer-form',
            storeName: 'stock_transfers',
            transactionType: 'create_transfer',
            redirectUrl: "{% url 'transfer_list' branch.id %}",
            onBeforeSave: async (data) => {
                // Parse items JSON
                const itemsJson = document.getElementById('items-json').value;
                if (!itemsJson) {
                    showToast('Please add items to transfer', 'warning');
                    return null;
                }
                
                const items = JSON.parse(itemsJson);
                if (items.length === 0) {
                    showToast('Please add items to transfer', 'warning');
                    return null;
                }

                // Add branch info
                data.source_branch_id = "{{ branch.id }}";
                data.items = items;

                // Capture destination branch name for local display
                const destSelect = document.getElementById('id_destination_branch');
                if (destSelect && destSelect.selectedIndex >= 0) {
                    data.destination_branch_name = destSelect.options[destSelect.selectedIndex].text;
                }
                
                // We also need to locally update stock for these products to reflect immediate change
                if (window.posDB) {
                    // This is an optimistic update. 
                    // In a real app we might want a more robust way to handle this shared state.
                    const products = await window.posDB.getAll('products');
                    const updates = [];
                    
                    for (const item of items) {
                        const product = products.find(p => p.id == item.product_id);
                        if (product) {
                            product.stock_quantity -= item.quantity;
                            // Update 'stock' alias if it exists
                            if (product.stock !== undefined) product.stock = product.stock_quantity;
                            updates.push(product);
                        }
                    }
                    
                    if (updates.length > 0) {
                         await window.posDB.bulkPut('products', updates);
                         console.log('[OfflineForm] Deducted stock locally for', updates.length, 'products');
                    }
                }

                return data;
            }
        });
    });
</script>
{% endblock %}
