{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Report Builder - Puxbay{% endblock %}
{% block page_title %}Custom Report Builder{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-8 h-[calc(100vh-12rem)]">
    <!-- Sidebar: Field Selector -->
    <div class="lg:col-span-1 bg-white rounded-3xl p-6 shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700 flex flex-col">
        <h3 class="text-sm font-black text-slate-900 border-b border-slate-100 pb-4 mb-4 dark:text-white dark:border-slate-700">Available Fields</h3>
        
        <div class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
            {% for field in selectable_fields %}
            <div data-id="{{ field.id }}" data-label="{{ field.label }}" class="field-item group flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-xl cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all dark:bg-slate-900 dark:border-slate-800 dark:hover:bg-blue-900/30">
                <span class="text-xs font-bold text-slate-600 group-hover:text-blue-700 dark:text-slate-400 dark:group-hover:text-blue-300">{{ field.label }}</span>
                <span class="material-symbols-outlined text-slate-400 text-sm group-hover:text-blue-500">add_circle</span>
            </div>
            {% endfor %}
        </div>
        
        <div class="pt-6 border-t border-slate-100 mt-6 dark:border-slate-700">
            <button id="run-report-btn" class="w-full py-4 bg-slate-900 hover:bg-indigo-600 text-white rounded-2xl font-black text-sm shadow-xl shadow-slate-900/20 transition-all flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-sm">play_arrow</span>
                Run Report
            </button>
        </div>
    </div>

    <!-- Main: Preview Area -->
    <div class="lg:col-span-3 flex flex-col gap-6">
        <!-- Selected Fields (Breadcrumbs style) -->
        <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
             <div class="flex items-center justify-between mb-4">
                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Active Columns</h4>
                <button id="clear-fields" class="text-[10px] font-bold text-red-500 hover:text-red-600 uppercase tracking-widest">Clear All</button>
            </div>
            <div id="selected-fields-container" class="flex flex-wrap gap-2">
                <p class="text-xs text-slate-400 italic py-2">Select fields from the left to start building your report.</p>
            </div>
        </div>

        <!-- Result Table -->
        <div class="flex-1 bg-white rounded-3xl shadow-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700 overflow-hidden flex flex-col">
            <div id="report-loader" class="hidden absolute inset-0 bg-white/80 dark:bg-slate-800/80 z-20 flex items-center justify-center">
                <div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            
            <div class="overflow-x-auto h-full overflow-y-auto">
                <table class="w-full text-left" id="report-table">
                    <thead class="sticky top-0 bg-slate-50 dark:bg-slate-900 z-10">
                        <tr id="table-headers">
                            <!-- Headers injected here -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 dark:divide-slate-700">
                        <!-- Data rows injected here -->
                    </tbody>
                </table>
                <div id="empty-state" class="py-24 text-center">
                    <span class="material-symbols-outlined text-4xl text-slate-200 mb-4">table_chart</span>
                    <p class="text-slate-400 text-sm">No data to display. Select fields and click "Run Report".</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const selectedFields = new Set();
    const fieldContainer = document.getElementById('selected-fields-container');
    const tableHeaders = document.getElementById('table-headers');
    const tableBody = document.getElementById('table-body');
    const emptyState = document.getElementById('empty-state');
    const loader = document.getElementById('report-loader');

    // Field Item Click
    document.querySelectorAll('.field-item').forEach(item => {
        item.addEventListener('click', () => {
            const id = item.dataset.id;
            const label = item.dataset.label;
            
            if (selectedFields.has(id)) return;
            
            selectedFields.add(id);
            updateSelectedUI();
        });
    });

    function updateSelectedUI() {
        if (selectedFields.size === 0) {
            fieldContainer.innerHTML = '<p class="text-xs text-slate-400 italic py-2">Select fields from the left to start building your report.</p>';
            return;
        }

        fieldContainer.innerHTML = '';
        selectedFields.forEach(id => {
            const label = document.querySelector(`.field-item[data-id="${id}"]`).dataset.label;
            const chip = document.createElement('div');
            chip.className = 'flex items-center gap-2 px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-full text-[11px] font-black border border-indigo-100 group dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800';
            chip.innerHTML = `
                ${label}
                <span class="material-symbols-outlined text-xs cursor-pointer hover:text-red-500 transition-colors" onclick="removeField('${id}')">close</span>
            `;
            fieldContainer.appendChild(chip);
        });
    }

    function removeField(id) {
        selectedFields.delete(id);
        updateSelectedUI();
    }

    document.getElementById('clear-fields').onclick = () => {
        selectedFields.clear();
        updateSelectedUI();
    };

    document.getElementById('run-report-btn').onclick = async () => {
        if (selectedFields.size === 0) {
            alert('Please select at least one field.');
            return;
        }

        loader.classList.remove('hidden');
        emptyState.classList.add('hidden');
        
        try {
            const params = new URLSearchParams();
            selectedFields.forEach(f => params.append('fields[]', f));
            
            const response = await fetch(`{% url 'report_builder_data' %}?${params.toString()}`);
            const result = await response.json();
            
            renderTable(result.data);
        } catch (err) {
            console.error(err);
            alert('Failed to generate report.');
        } finally {
            loader.classList.add('hidden');
        }
    };

    function renderTable(data) {
        // Headers
        tableHeaders.innerHTML = '';
        selectedFields.forEach(id => {
            const label = document.querySelector(`.field-item[data-id="${id}"]`).dataset.label;
            const th = document.createElement('th');
            th.className = 'px-6 py-4 text-[10px] font-black uppercase text-slate-500 tracking-widest';
            th.textContent = label;
            tableHeaders.appendChild(th);
        });

        // Body
        tableBody.innerHTML = '';
        if (data.length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors';
            
            selectedFields.forEach(id => {
                const td = document.createElement('td');
                td.className = 'px-6 py-4 text-xs text-slate-700 dark:text-slate-300 font-medium';
                // Handle nested fields like branch__name
                td.textContent = row[id] || '-';
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
    }
</script>
{% endblock %}
